From d5712811312c2fad85fe63630492b02b8b0cf545 Mon Sep 17 00:00:00 2001
From: Elizabeth Liner <eliner@us.ibm.com>
Date: Tue, 27 Jun 2017 11:59:51 -0500
Subject: [PATCH 2/2] eliner second try

---
 create_pnor_image.pl                |  7 ++++++-
 p9Layouts/defaultPnorLayout_128.xml |  2 +-
 p9Layouts/defaultPnorLayout_32.xml  |  2 +-
 p9Layouts/defaultPnorLayout_64.xml  |  2 +-
 update_image.pl                     | 17 +++++++++++++++--
 5 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/create_pnor_image.pl b/create_pnor_image.pl
index dd2f840..9048d8d 100755
--- a/create_pnor_image.pl
+++ b/create_pnor_image.pl
@@ -20,6 +20,7 @@ my $wink_binary_filename = "";
 my $occ_binary_filename = "";
 my $openpower_version_filename = "";
 my $wofdata_binary_filename = "";
+my $memddata_binary_filename = "";
 
 while (@ARGV > 0){
     $_ = $ARGV[0];
@@ -94,6 +95,10 @@ while (@ARGV > 0){
         $wofdata_binary_filename = $ARGV[1] or die "Bad command line arg given: expecting a wofdata binary filename.\n";
         shift;
     }
+    elsif (/^-memddata_binary_filename/i){
+        $memddata_binary_filename = $ARGV[1] or die "Bad command line arg given: expecting a memddata binary filename.\n";
+        shift;
+    }
     else {
         print "Unrecognized command line arg: $_ \n";
         print "To view all the options and help text run \'$program_name -h\' \n";
@@ -139,7 +144,7 @@ $build_pnor_command .= " --binFile_IMA_CATALOG $scratch_dir/ima_catalog.bin.ecc"
 
 if ($release eq "p9"){
     $build_pnor_command .= " --binFile_WOFDATA $wofdata_binary_filename" if -e $wofdata_binary_filename;
-    $build_pnor_command .= " --binFile_MEMD $scratch_dir/memd_data.bin.ecc";
+    $build_pnor_command .= " --binFile_MEMD $memddata_binary_filename" if -e $memddata_binary_filename;
 }
 if ($release eq "p8"){
     $build_pnor_command .= " --binFile_SBEC $scratch_dir/$sbec_binary_filename";
diff --git a/p9Layouts/defaultPnorLayout_128.xml b/p9Layouts/defaultPnorLayout_128.xml
index 2fde053..4c836e1 100644
--- a/p9Layouts/defaultPnorLayout_128.xml
+++ b/p9Layouts/defaultPnorLayout_128.xml
@@ -311,7 +311,7 @@ Layout Description
         <volatile/>
     </section>
     <section>
-        <description>MEMD extra data</description>
+        <description>MEMD extra data (24K)</description>
         <eyeCatch>MEMD</eyeCatch>
         <physicalOffset>0x2B03000</physicalOffset>
         <physicalRegionSize>0x6000</physicalRegionSize>
diff --git a/p9Layouts/defaultPnorLayout_32.xml b/p9Layouts/defaultPnorLayout_32.xml
index 4af8855..899e965 100644
--- a/p9Layouts/defaultPnorLayout_32.xml
+++ b/p9Layouts/defaultPnorLayout_32.xml
@@ -311,7 +311,7 @@ Layout Description
         <volatile/>
     </section>
     <section>
-        <description>MEMD extra data</description>
+        <description>MEMD extra data (24K)</description>
         <eyeCatch>MEMD</eyeCatch>
         <physicalOffset>0x2B03000</physicalOffset>
         <physicalRegionSize>0x6000</physicalRegionSize>
diff --git a/p9Layouts/defaultPnorLayout_64.xml b/p9Layouts/defaultPnorLayout_64.xml
index aadf756..b137092 100644
--- a/p9Layouts/defaultPnorLayout_64.xml
+++ b/p9Layouts/defaultPnorLayout_64.xml
@@ -311,7 +311,7 @@ Layout Description
         <volatile/>
     </section>
     <section>
-        <description>MEMD extra data</description>
+        <description>MEMD extra data (24K)</description>
         <eyeCatch>MEMD</eyeCatch>
         <physicalOffset>0x2B95000</physicalOffset>
         <physicalRegionSize>0x6000</physicalRegionSize>
diff --git a/update_image.pl b/update_image.pl
index 143b354..393c95b 100755
--- a/update_image.pl
+++ b/update_image.pl
@@ -23,6 +23,7 @@ my $openpower_version_filename = "";
 my $payload = "";
 my $xz_compression = 0;
 my $wof_binary_filename = "";
+my $memd_binary_filename = "";
 
 while (@ARGV > 0){
     $_ = $ARGV[0];
@@ -104,6 +105,11 @@ while (@ARGV > 0){
         $wof_binary_filename = $ARGV[1];
         shift;
     }
+    elsif (/^-memd_binary_filename/i){
+        #This filename is necessary if the file exists, but if it's not given, we add in a blank partition
+        $memd_binary_filename = $ARGV[1];
+        shift;
+    }
     else {
         print "Unrecognized command line arg: $_ \n";
         #print "To view all the options and help text run \'$program_name -h\' \n";
@@ -287,10 +293,17 @@ elsif ($release eq "p9")
     run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/wofdata.bin.ecc --p8");
 }
 
+#Encode ECC into the MEMD Partition
+if ($release eq "p9" && -e $memd_binary_filename) {
+    run_command("dd if=$memd_binary_filename > $scratch_dir/hostboot.temp.bin");
+    run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/memd_extra.bin.ecc --p8");
+}
+
 #Create blank binary file for MEMD Partition (for now)
-if ($release eq "p9") {
+elsif ($release eq "p9") {
+    print "ERROR: MEMD partition is not found, including blank binary instead\n";
     run_command("dd if=/dev/zero bs=20K count=1 | tr \"\\000\" \"\\377\" > $scratch_dir/hostboot.temp.bin");
-    run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/memd_data.bin.ecc --p8");
+    run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/memd_extra_data.bin.ecc --p8");
 }
 
 
-- 
1.8.2.2

